<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout/basic">

<th:block layout:fragment="title">
    <title>내 정보 보기</title>
</th:block>

<th:block layout:fragment="add-css">
    <style>
        .default-thumbnail {
            width: 200px;
            height: 200px;
            border: 0px;
        }
    </style>
</th:block>

<th:block layout:fragment="content">
    <!-- 제목 -->
    <div class="mt-4 mb-4 d-flex align-items-center">
        <i class="fas fa-user-edit me-1 fa-2x me-1"></i>
        <h2 class="mb-0">내 정보 수정</h2>
    </div>
    <div class="row">
        <div class="col-xl-4">
            <!--프로필 사진 수정-->
            <div class="card mb-4 d-flex mb-xl-0">
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-edit me-1-2x me-1"></i>
                    <p class="mb-0 fw-bold">프로필 사진 수정</p>
                </div>
                <form action="/myPage/profile" method="POST" id="profileForm" enctype="multipart/form-data">
                    <div class="card-body text-center">
                        <!--프로필 사진 없을 때-->
                        <div th:if="${#strings.isEmpty(user.fbUserImg)}">
                            <img class="img-account-profile default-thumbnail rounded-circle mb-2 profileImg"
                                 th:src="'/assets/img/userImg/user_icon.jpg'">
                        </div>
                        <!--프로필 사진 있을 때-->
                        <div th:unless="${#strings.isEmpty(user.fbUserImg)}">
                            <img class="img-account-profile default-thumbnail rounded-circle mb-2 profileImg"
                                 th:src="@{/myPage/profile/}+${session.userId}" />
                        </div>
                        <div class="small font-italic text-muted mb-4">5MB이하의 jpg,png 파일을 선택해주세요 </div>
                        <div class="col">
                            <input class="d-none" type="file" name="profileImg" id="imgInput" accept=".jpg .png">
                            <button class="btn btn-secondary d-block mb-2 w-100" type="button" onclick="uploadImg();">프로필 사진 선택</button>
                            <button class="btn btn-danger d-block mb-2 w-100" type="button" id="deleteImg">프로필 사진 삭제</button>
                            <input type="submit" class="btn btn-primary d-block mb-2 w-100" value="프로필 사진 변경하기">
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-xl-8">
            <!--정보 수정-->
            <div class="card mb-4">
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-edit me-1-2x me-1"></i>
                    <p class="mb-0 fw-bold">정보 수정(수정할 정보를 입력 후 현재 비밀번호를 입력해주세요)</p>
                </div>
                <div class="card-body">
                    <form>
                        <!--이메일-->
                        <div class="mb-3">
                            <label class="small mb-1" for="inputEmailAddress">이메일</label>
                            <input class="form-control" id="inputEmailAddress" type="email" placeholder="Enter your email address"
                                   th:value="${user.fbUserEmail}" readonly>
                        </div>
                        <!--닉네임-->
                        <div class="mb-3">
                            <label class="small mb-1" for="inputUserNickname">닉네임</label>
                            <input class="form-control" id="inputUserNickname" type="text" placeholder="Enter your nickname"
                                   th:value="${user.fbUserNickname}" readonly>
                        </div>
                        <!--이름-->
                        <div class="mb-3">
                            <label class="small mb-1" for="inputUsername">이름</label>
                            <input class="form-control" id="inputUsername" type="text" placeholder="Enter your username"
                                   th:value="${user.fbUserName}">
                        </div>
                        <!--핸드폰 번호 및 생년월일-->
                        <div class="row gx-3 mb-3">
                            <!-- 핸드폰 번호-->
                            <div class="col-md-6">
                                <label class="small mb-1" for="inputPhone">핸드폰 번호</label>
                                <input class="form-control" id="inputPhone" type="tel" placeholder="Enter your phone number"
                                       th:value="${user.fbUserPhone}">
                            </div>
                            <!-- 생년월일-->
                            <div class="col-md-6">
                                <label class="small mb-1" for="inputBirth">생년월일</label>
                                <input class="form-control" id="inputBirth" type="text" name="birthday" placeholder="Enter your birthday"
                                       th:value="${user.fbUserBirth}">
                            </div>
                        </div>
                        <!--주소-->
                        <div class="mb-3">
                            <label class="small mb-1" for="inputUserAddress">주소</label>
                            <input class="form-control" id="inputUserAddress" type="text" placeholder="Enter your address"
                                   th:value="${user.fbUserAddress}">
                        </div>
                        <!--비밀번호-->
                        <div class="row gx-3 mb-3">
                            <div class="mb-3">
                                <label class="small mb-1" for="inputUsername">비밀번호 변경</label>
                                <input class="form-control" id="currentUserPswd" type="password" placeholder="현재 비밀번호를 입력해주세요">
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" id="userPswd" type="password" placeholder="변경할 비밀번호를 입력해주세요">
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" id="userPswdConf" type="password" placeholder="다시 확인해주세요">
                            </div>
                        </div>
                        <!--정보 수정하기 버튼-->
                        <button class="btn btn-primary d-block w-100" type="button">정보 수정하기</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        window.onload = () => {

        }

        // 프로필 이미지 추가/변경/삭제
        const profileImg = document.querySelector('.profileImg'); // img 요소
        const imgInput = document.querySelector('#imgInput'); // input 요소
        const deleteImg = document.querySelector('#deleteImg'); // delete input 요소

        // 초기 프로필 이미지 상태를 저장
        let initCheck; // false == 기본, true == 이전 업로드

        // 프로필 이미지가 새로 업로드되거나 삭제되었음을 나타냄
        let deleteCheck = -1; // -1 == 초기값, 0 == 프로필 삭제, 1 == 새 업로드 이미지

        // 초기 프로필 이미지 파일 경로 저장
        let originalImg;

        // 화면에 imgInput이 있을 경우
        if(imgInput != null){

            // 프로필 이미지가 출력되는 img 요소의 src 속성을 저장
            originalImg = profileImg.getAttribute("src");

            // 현재 회원의 프로필 이미지 상태 확인
            if(originalImg == '/assets/img/userImg/user_icon.jpg'){
                // 기본 이미지인 경우
                initCheck = false;
            }else {
                initCheck = true;
            }
        }

        imgInput.addEventListener("change", e => {

            // 5MB로 최대 크기 제한
            const maxSize = 1 * 1024 * 1024 * 5; // 파일의 최대 크기 지정(바이트)
            console.log(e.target); // input
            console.log(e.target.value); // 업로드된 파일 경로
            console.log(e.target.files); // 업로드된 파일의 정보가 담긴 배열

            const file = e.target.files[0]; // 업로드한 파일의 정보가 담긴 객체

            // 파일을 한 번 선택한 후 취소했을 때
            if(file == undefined){
                console.log("파일 선택이 취소됨");
                deleteCheck = -1; // 취소 == 파일 없음

                // 취소 시 기존 프로필 이미지로 변경
                profileImg.setAttribute("src", originalImg);
                return;
            }

            // 선택된 파일의 크기가 최대 크기를 초과한 경우
            if(file.size > maxSize){
                alert("5MB 이하의 이미지를 선택해 주세요.");
                imgInput.value = "";
                deleteCheck = -1; // 취소 == 파일 없음
                // 기존 프로필 이미지로 변경
                profileImg.setAttribute("src", originalImg);
                return;
            }

            // JS에서 파일을 읽는 객체 - 파일을 읽고 클라이언트 컴퓨터에 파일 저장 가능
            const reader = new FileReader();

            // 매개변수에 작성된 파일을 읽어서 저장 후,
            // 파일을 나타내는 URL을 result 속성으로 얻어올 수 있음
            reader.readAsDataURL(file);

            // 다 읽었을 때
            reader.onload = e => {
                // 읽은 파일의 url
                const url = e.target.result;

                // 프로필 이미지 속성에 src 속성으로 추가
                profileImg.setAttribute("src", url);

                deleteCheck = 1;
            }
        });

        // 삭제하기 버튼 클릭 시
        deleteImg.addEventListener("click", () =>{

            // 프로필 이미지를 기본 이미지로 변경
            profileImg.setAttribute("src", "/assets/img/userImg/user_icon.jpg");
            // input type="file"의 value 삭제
            imgInput.value = "";
            deleteCheck = 0;
        });

        // profileForm이 제출되었을 때
        document.querySelector('#profileForm').addEventListener("submit", e =>{

            // let initCheck;
            // 초기 프로필 이미지 상태를 저장하는 변수
            // false == 기본 이미지, true == 이전 업로드 이미지

            // let deleteCheck = -1;
            // 프로필 이미지가 새로 업로드되거나 삭제되었음을 나타내는 변수
            // -1 == 초기값, 0 == 프로필 삭제(x버튼), 1 == 새 업로드 이미지

            let flag = true;

            // 프로필 이미지가 없다 -> 있다
            if(!initCheck && deleteCheck == 1){
                flag = false;
            }
            // 이전 프로필 이미지가 있다 -> 삭제
            if(initCheck && deleteCheck == 0){
                flag = false;
            }
            // 이전 프로필 이미지가 있다 -> 변경
            if(initCheck && deleteCheck == 1){
                flag = false;
            }

            // flag == true -> 제출하면 안 되는 경우
            if(flag){
                e.preventDefault(); // form 기본 이벤트 제거
                alert('이미지를 선택 후 변경하여 주세요!');
            }

        });

        // 프로필 사진 올리기 버튼
        function uploadImg(){
            // 파일 선택 input 가져오기
            let imgInput = document.querySelector('#imgInput');

            // 파일 선택 input 클릭
            imgInput.click();
        }
    </script>
</th:block>

</html>
